---
title: "ETC5521 Assignment 1"
subtitle: "Spotify Music Exploratory Data Analysis"
team: wallaby
author:
  - Chengzhi Ye
  - Yan Ma
date: "`r Sys.Date()`"
output: 
  html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(devtools)
library(readr)
library(tidyverse)
library(dplyr)
library(lubridate)
library(ggplot2)
library(spotifyr)
library(skimr)
library(knitr)
library(kableExtra)
library(ggjoy)
library(forcats)
library(broom)
library(gridExtra)
library(genius)
library(tidytext)
library(textdata)
```

<center><img src="https://cdn.musebycl.io/styles/large_wide/s3/2019-04/spotify-music-for-every-mood-hed-2019.jpg?itok=nT0AgVbz"></center>


[This assignment is for ETC5521 Assignment 1 by Team `r rmarkdown::metadata$team` comprising of `r knitr::combine_words(rmarkdown::metadata$author)`.]{style="color:#006DAE;"}


# Introduction and motivation

[FILL] Give the bigger picture of the data, and inspire the reader to learn more about the problem by reading your analysis. 

# Data description
```{r read-data, eval=FALSE}
readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-01-21/spotify_songs.csv') %>% 
  write.csv("spotify_songs.csv")
```

```{r read-csv}
spotify_songs <- read.csv(here::here("spotify_songs.csv"))
```

The data of this report is part of the [tidytuesday chanllenge](https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-01-21/readme.md), which comes from [Spotify](https://www.spotify.com/) via the  [spotifyr](https://www.rdocumentation.org/packages/spotifyr/versions/2.1.1) package.

The **variables** in this dataset are `r names(spotify_songs)`, time frame of collection is from 1957-01-01 to 2020-01-29.

**Data collection methods:** Spotifyr is an R wrapper for pulling track audio features and other information from Spotify’s Web API in bulk. By automatically batching API requests, it allows you to enter an artist’s name and retrieve their entire discography in seconds, along with Spotify’s audio features and track/album popularity metrics. You can also pull song and playlist information for a given Spotify User.

Here is a brief summary of the **data structure**:

```{r data-structure}
skimr::skim(spotify_songs)
```






# Analysis and findings

### interactive table - Top Artists all over the time

interactive table & bar_plot (top20) & polar plot

### Analyse our favorate artist

In this part, we want to take one artist for example to do some detailed exploratory analysis using the "spotifyr" package. Here we choose the Coldplay, our favorate artist. 

First, we loaded all the albums of Coldplay available on spotify and droped the duplicate ones (some live tour albums are duplicate with the existed ones). We calculated the average valence of each album. The results are shown in the following table. According to [the spotify tracks documentation](https://developer.spotify.com/documentation/web-api/reference/tracks/get-audio-features/), _The valence variable is measured from 0.0 to 1.0, describing the musical positiveness conveyed by a track. Tracks with high valence sound more positive (e.g. happy, cheerful, euphoric), while tracks with low valence sound more negative (e.g. sad, depressed, angry)._
The highest valence of these albums is 0.3, and the lowest valence is 0.18, which means the songs of Coldplay usually sounds more negative than positive for the audience.

```{r}
Sys.setenv(SPOTIFY_CLIENT_ID = "d11442c742ef4d30bc6ac5f7d16ad9a3")
Sys.setenv(SPOTIFY_CLIENT_SECRET = "29bf6f95fe894329ba9204cd9e72b68e")
access_token <- get_spotify_access_token()
```

```{r coldplay-album}
coldplay <- get_artist_audio_features("coldplay")

albums_valence <- coldplay %>% 
  group_by(album_name) %>% 
  filter(!album_name %in% c("Ghost Stories Live 2014", "Live in Buenos Aires", "A Head Full of Dreams Tour Edition")) %>% 
  summarise(mean_valence = mean(valence))

albums_valence <- rename(albums_valence, valence = mean_valence)

albums_valence %>% 
  arrange(desc(valence)) %>% 
  kable(digits = 2, caption = "Joyfullness of Coldplay's albums", booktabs = T) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))
```


Second, we make a density plot to show the ranges and densities of valence of each album. From the following figure, we can find that "Everyday Life" has the widest range of valence, that is to say, this album contains abundant emotions. Meanwhile, "A Rush of Blood to the Head" has a narrow range of valence, and the valence desity centered at the area with lower valence values. It's probably that the audience would feel negative emotions like sad, depressed and angry when they listening this album. This finding surprised us because the "A Rush of Blood to the Head" is the second best album in ["The Coldplay Albums Ranked"](The Coldplay Albums Ranked). So we decided to look more in depth next.

```{r coldplay-valence}
coldplay %>% 
  group_by(album_name) %>% 
  filter(!album_name %in% c("Ghost Stories Live 2014", "Live in Buenos Aires", "Love in Tokyo", "A Head Full of Dreams Tour Edition")) %>% # remove the duplicate ones
  ggplot(aes(x = valence, y = album_name, fill = ..x..)) + 
  geom_density_ridges_gradient() + 
  theme(legend.position = "none") + 
  ggtitle("The valence density of Coldplay's albums")
```

Lastly, we analysed the sentiment of this album to see whether the valence of an album is associated with the lyrics. The average sentiment value of this album is -0.47 by the "afinn" lexicon. And we also analysed the sentiment of lyrics using the "bing" lexicon. The following table shows the most frequent words and their sentiment in this album. In addition, the figure below shows more intuitively the frequency of words which appears more than once. We can easily find that the negative words appear more than the positive ones.

As a result, we can say for sure that, both in terms of sound and lyrics, this album conveyed negative emotions. But this dosen't affect that people think "A Rush of Blood to the Head" is one of the best albums of the Coldplay. It can be seen that the audience's love for a album is not entirely determined by the album's positiveness. 

```{r my favorate-album-lyrics, cache=TRUE}
rush <- genius_album(artist = "coldplay", album = "a rush of blood to the head")

rush_bing <- rush %>% 
  unnest_tokens(word, lyric) %>% 
  anti_join(stop_words) %>% 
  inner_join(get_sentiments("bing"))

rush_bing %>% 
  count(word, sentiment, sort = TRUE) %>% 
  head(5) %>% 
  kable(caption = "The most frequent words in 'A rush of blood to the head'", booktabs = T) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r sentiment-plot}
rush_bing %>% 
  count(word, sentiment, sort = TRUE) %>% 
  filter(n >= 2) %>% 
  ggplot(aes(reorder(word, n), n, fill = sentiment)) + 
  geom_col() + 
  coord_flip() + 
  theme(axis.title.y=element_blank()) + 
  facet_wrap(~sentiment, scales = "free_y") + 
  ggtitle("sentiment of the album 'A rush of blood to the head'")
```

```{r sentiment-value}
rush_afinn <- rush %>% 
  unnest_tokens(word, lyric) %>% 
  anti_join(stop_words) %>% 
  inner_join(get_sentiments("afinn")) 

rush_sentiment_value <- round(mean(rush_afinn$value), digits = 2)
```

### Characteristics of each genre(?)

The table below shows the ditribution of each genre in this dataset. The most frequently appeared genre is "edm", while the genre "rock" appeared least.

```{r genres-summary}
spotify_songs %>% 
  count(playlist_genre, sort = TRUE) %>%
  kable(caption = "Genres in the dataset", booktabs = T) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))
```

### Each type of songs was populated in what time period?

The following figure shows the average popularity of songs released in different time. To show the result clearly and for convenience of comparision, we devided the result for each genre. 
(1) The edm music has been popular since the 1970s, and the popularities of edm music released in the past 50 years are 40 or even less. This means the edm music is not the mainstream music type nowadays. 
(2) The latin and pop music have been popular since the 1960s. The 1970s was the golden time for the latin songs, while the 1960s and 1970s were the golden time for the pop music. These old songs are still popular now. 
(3) The r&b music went through ups and downs. The songs released from the 1980s to the 2000s are less popular than others. 
(4) The rap music has been popular since the 1960s, and the oldest rap music is still the most popular ones. And the songs released in the 2000s have the lowest popularity now. 
(5) The popularitise of rock music released in different time period are quite stable. While the ones released from the 1960s to the 1990s are more popular than the others.

```{r time-popular}
spotify_songs <- spotify_songs %>% 
  mutate(year = substr(track_album_release_date, 1, 4))

spotify_songs <- spotify_songs %>% 
  mutate(decade = round(as.numeric(year) - 4.5, -1))

time_popular <- spotify_songs %>% 
  select(c("playlist_genre", "decade", "track_popularity")) %>%
  pivot_longer(cols = playlist_genre) %>% 
  group_by(as.character(value), as.character(decade)) %>% 
  summarise(mean_popularity = mean(track_popularity)) 

rename(time_popular, genre = `as.character(value)`, 
       decade = `as.character(decade)`) -> time_popular

time_popular %>% 
  ggplot() +
  geom_col(aes(x = decade, y = mean_popularity, 
               fill = decade), alpha = 0.5) + 
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
  facet_wrap(~genre)

```

### Features analysis

In this part, we analysed the audio features of all the songs in our dataset. The figure below shows how these features like in different genres. Here's a simple explaination of these features:

- acousticness: A confidence measure from 0.0 to 1.0 of whether the track is acoustic. 

- danceablity: Danceability describes how suitable a track is for dancing. A value of 0.0 is least danceable and 1.0 is most danceable.

- duration_ms: The duration of the track in milliseconds.

- energy: Energy is a measure from 0.0 to 1.0 and represents a perceptual measure of intensity and activity. Typically, energetic tracks feel fast, loud, and noisy.

- instrumentalness: Predicts whether a track contains no vocals. 

- key: The key the track is in. 

- liveness: Detects the presence of an audience in the recording. Higher liveness values represent an increased probability that the track was performed live.

- loudness: The overall loudness of a track in decibels (dB).

- mode: Mode indicates the modality (major or minor) of a track, the type of scale from which its melodic content is derived. Major is represented by 1 and minor is 0.

- speechness: Speechiness detects the presence of spoken words in a track. 

- tempo: The overall estimated tempo of a track in beats per minute (BPM). 

- valence: A measure from 0.0 to 1.0 describing the musical positiveness conveyed by a track. Tracks with high valence sound more positive (e.g. happy, cheerful, euphoric), while tracks with low valence sound more negative (e.g. sad, depressed, angry).

```{r features-genre}
feature_names <- names(spotify_songs)[13:24]

spotify_songs %>%
  select(c("playlist_genre", feature_names)) %>%
  pivot_longer(cols = feature_names) %>%
  ggplot(aes(x = value)) +
  geom_density(aes(color = playlist_genre), alpha = 0.5) +
  facet_wrap(~name, ncol = 3, scales = 'free') +
  labs(title = "Spotify Audio Feature Density - by Genre",
       x = "", y = "density") +
  theme(axis.text.y = element_blank(), 
        axis.ticks = element_blank()) + 
  scale_color_brewer(palette = "Accent")
```

#### box plot - features(x)

#### correlation(x)



### Features and popularity(?)

Then we want to explore whether these audio features contribute to a higher popularity using a linear regression model. The following table shows all the audio features with a p-value less than 0.05. We can find that danceability contributes most to a higher popularity, and loudness also has a positive relationship with popularity.

```{r features-popularity}
popular_songs <- spotify_songs %>% 
  filter(track_popularity > 50)

fit1 <- lm((track_popularity * 10) ~ acousticness + danceability + duration_ms + 
             energy + instrumentalness + key + liveness + loudness + 
             mode + speechiness + tempo + valence, data = popular_songs)

result <- as.data.frame(tidy(fit1)) %>% 
  filter(p.value < 0.05)

kable(result, digits = 2, caption = "lm(popularity~features)", booktabs = T) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))
```

Then we ploted each audio feature of the songs and the popularity in the following figure. It shows that liveness has a negative relationship with popularity, with is the same with our linear model. And we can't find any relationship between valence and popularity, this is consistent with our linear model and sentiment analysis.

```{r popularity-against-features}
dance_popular <- spotify_songs %>% 
  ggplot() + 
  geom_point(aes(x = danceability, y = track_popularity), color = "#E69F00", alpha = 0.05)

loudness_popular <- spotify_songs %>% 
  ggplot() + 
  geom_point(aes(x = loudness, y = track_popularity), color = "#009E73", alpha = 0.05) + 
  xlim(-30, 0)

valence_popular <- spotify_songs %>% 
  ggplot() + 
  geom_point(aes(x = valence, y = track_popularity), color = "#CC79A7", alpha = 0.05)

energy_popular <- spotify_songs %>% 
  ggplot() + 
  geom_point(aes(x = energy, y = track_popularity), color = "#56B4E9", alpha = 0.05)

instrumentalness_popular <- spotify_songs %>% 
  ggplot() + 
  geom_point(aes(x = instrumentalness, y = track_popularity), color = "#0072B2", alpha = 0.05)

liveness_popular <- spotify_songs %>% 
  ggplot() + 
  geom_point(aes(x = liveness, y = track_popularity), color = "#D55E00", alpha = 0.05)

speechiness_popular <- spotify_songs %>% 
  ggplot() + 
  geom_point(aes(x = speechiness, y = track_popularity), color = "#C4961A", alpha = 0.05)

duration_popular <- spotify_songs %>% 
  ggplot() + 
  geom_point(aes(x = duration_ms, y = track_popularity), color = "#C3D7A4", alpha = 0.05)

grid.arrange(dance_popular, loudness_popular, valence_popular, 
             energy_popular, instrumentalness_popular, liveness_popular, 
             speechiness_popular, duration_popular, ncol = 3)
```




## Limitation

1. popularity: too many zeros & how to calculate it





# References








